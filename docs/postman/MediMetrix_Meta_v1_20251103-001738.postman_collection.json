{
  "info": {
    "name": "MediMetrix • Meta (v1)",
    "_postman_id": "Meta-20251103-001738",
    "description": "Coleção de testes para a entidade Meta, com bootstrap e regras de unicidade/validação.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Guard: only initialize once per run",
          "if (!pm.environment.get('metaInit')) {",
          "  pm.environment.set('metaInit', 'true');",
          "  const now = new Date();",
          "  const rnd = Math.floor(Math.random()*100000);",
          "  // pick a start date today + [1..20] days to avoid UNIQUE collisions",
          "  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (1 + (rnd % 20)));",
          "  const pad = n => String(n).padStart(2,'0');",
          "  const iso = `${start.getFullYear()}-${pad(start.getMonth()+1)}-${pad(start.getDate())}`;",
          "  pm.environment.set('metaVigenciaInicio', iso);",
          "  pm.environment.set('metaVigenciaFim', '');",
          "  // alvo aleatório de 3.00 a 5.00 com 2 casas",
          "  const alvo = (300 + (rnd % 200)) / 100.0;",
          "  pm.environment.set('metaAlvo', alvo.toFixed(2));",
          "  // operador padrão",
          "  pm.environment.set('metaOperador', '>=');",
          "  // prioridade 1..3",
          "  pm.environment.set('metaPrioridade', String(1 + (rnd % 3)));",
          "  // justificativa",
          "  pm.environment.set('metaJust', `Meta auto ${rnd}`);",
          "}"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "00 • Bootstrap",
      "item": [
        {
          "name": "Selecionar Critério existente",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/criterios?page=0&size=50&asc=true",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "criterios?page=0&size=50&asc=true"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const arr = pm.response.json();",
                  "pm.test('lista criterios', () => pm.expect(Array.isArray(arr)).to.be.true);",
                  "const id = (arr[0] && arr[0].id) ? arr[0].id : '';",
                  "pm.environment.set('bootstrapCriterioId', id);",
                  "pm.test('criterioId definido', () => pm.expect(id).to.be.ok);"
                ]
              }
            }
          ]
        },
        {
          "name": "Selecionar Unidade existente",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/unidades?page=0&size=50&asc=true",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "unidades?page=0&size=50&asc=true"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const arr = pm.response.json();",
                  "pm.environment.set('bootstrapUnidadeId', (arr[0] && arr[0].id) ? arr[0].id : '');",
                  "pm.test('unidadeId definido', () => pm.expect(pm.environment.get('bootstrapUnidadeId')).to.be.ok);"
                ]
              }
            }
          ]
        },
        {
          "name": "Selecionar Especialidade ativa",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/especialidades?page=0&size=50&asc=true",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "especialidades?page=0&size=50&asc=true"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const arr = pm.response.json();",
                  "let id = ''; for (const e of arr) { if (e.ativo) { id = e.id; break; }}",
                  "if (!id && arr.length) id = arr[0].id;",
                  "pm.environment.set('bootstrapEspecialidadeId', id);",
                  "pm.test('especialidadeId definido', () => pm.expect(id).to.be.ok);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "01 • Create & Read",
      "item": [
        {
          "name": "Criar Meta (201 + Location)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"idCriterio\": {{bootstrapCriterioId}},\n  \"idUnidade\": {{bootstrapUnidadeId}},\n  \"idEspecialidade\": {{bootstrapEspecialidadeId}},\n  \"alvo\": {{metaAlvo}},\n  \"operador\": \"{{metaOperador}}\",\n  \"vigenciaInicio\": \"{{metaVigenciaInicio}}\",\n  \"prioridade\": {{metaPrioridade}},\n  \"justificativa\": \"{{metaJust}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('201 Created', () => pm.response.to.have.status(201));",
                  "pm.test('Location presente', () => pm.expect(pm.response.headers.has('Location')).to.be.true);",
                  "const loc = pm.response.headers.get('Location');",
                  "const m = /\\/api\\/v1\\/metas\\/(\\d+)$/.exec(loc||'');",
                  "pm.environment.set('metaId', m && m[1] ? m[1] : '');",
                  "pm.test('id da meta extraído', () => pm.expect(pm.environment.get('metaId')).to.be.ok);"
                ]
              }
            }
          ]
        },
        {
          "name": "GET Meta por ID (200)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas/{{metaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas",
                "{{metaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const b = pm.response.json();",
                  "['id','idCriterio','alvo','operador','ativo','dataCriacao','dataUltimaEdicao'].forEach(k => pm.expect(b).to.have.property(k));",
                  "pm.expect(b.id).to.eql(Number(pm.environment.get('metaId')));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "02 • Update (PUT) e GET",
      "item": [
        {
          "name": "Atualizar Meta (204)",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas/{{metaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas",
                "{{metaId}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"alvo\": 4.99,\n  \"operador\": \">=\",\n  \"vigenciaFim\": \"{{metaVigenciaInicio}}\",\n  \"ativo\": true,\n  \"prioridade\": 3,\n  \"justificativa\": \"ajuste pós-criação\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('204 No Content', () => pm.response.to.have.status(204));"
                ]
              }
            }
          ]
        },
        {
          "name": "GET após Update (200)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas/{{metaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas",
                "{{metaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "const b = pm.response.json();",
                  "pm.expect(b.prioridade).to.eql(3);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "03 • Listagens",
      "item": [
        {
          "name": "Listar por critério (200)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas?idCriterio={{bootstrapCriterioId}}&page=0&size=10",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas?idCriterio={{bootstrapCriterioId}}&page=0&size=10"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "pm.test('é lista', () => pm.expect(Array.isArray(pm.response.json())).to.be.true);"
                ]
              }
            }
          ]
        },
        {
          "name": "Listar por escopo (critério+unidade+especialidade) (200)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas?idCriterio={{bootstrapCriterioId}}&idUnidade={{bootstrapUnidadeId}}&idEspecialidade={{bootstrapEspecialidadeId}}&page=0&size=10",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas?idCriterio={{bootstrapCriterioId}}&idUnidade={{bootstrapUnidadeId}}&idEspecialidade={{bootstrapEspecialidadeId}}&page=0&size=10"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "pm.test('é lista', () => pm.expect(Array.isArray(pm.response.json())).to.be.true);"
                ]
              }
            }
          ]
        },
        {
          "name": "Listar vigentes na data (200)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas?naData={{metaVigenciaInicio}}&page=0&size=10",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas?naData={{metaVigenciaInicio}}&page=0&size=10"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200 OK', () => pm.response.to.have.status(200));",
                  "pm.test('é lista', () => pm.expect(Array.isArray(pm.response.json())).to.be.true);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "04 • Negativos & Regras",
      "item": [
        {
          "name": "Criar Meta com operador inválido (400)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"idCriterio\": {{bootstrapCriterioId}},\n  \"alvo\": 4.00,\n  \"operador\": \"><\",\n  \"vigenciaInicio\": \"{{metaVigenciaInicio}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('400 Bad Request', () => pm.response.to.have.status(400));"
                ]
              }
            }
          ]
        },
        {
          "name": "Criar Meta com vigência inválida (inicio > fim) (400)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"idCriterio\": {{bootstrapCriterioId}},\n  \"alvo\": 4.10,\n  \"operador\": \">=\",\n  \"vigenciaInicio\": \"2099-12-31\",\n  \"vigenciaFim\": \"2099-01-01\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('400 Bad Request', () => pm.response.to.have.status(400));"
                ]
              }
            }
          ]
        },
        {
          "name": "Criar Meta duplicada (UNIQUE) (409)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"idCriterio\": {{bootstrapCriterioId}},\n  \"idUnidade\": {{bootstrapUnidadeId}},\n  \"idEspecialidade\": {{bootstrapEspecialidadeId}},\n  \"alvo\": 4.20,\n  \"operador\": \">=\",\n  \"vigenciaInicio\": \"{{metaVigenciaInicio}}\"\n}"
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('409 Conflict (unique)', () => pm.response.to.have.status(409));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "05 • Ativar/Desativar",
      "item": [
        {
          "name": "Desativar Meta (204)",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas/{{metaId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas",
                "{{metaId}}"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('204 No Content', () => pm.response.to.have.status(204));"
                ]
              }
            }
          ]
        },
        {
          "name": "Reativar Meta (204)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas/{{metaId}}/ativar",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas",
                "{{metaId}}",
                "ativar"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('204 No Content', () => pm.response.to.have.status(204));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "99 • Cleanup (opcional)",
      "item": [
        {
          "name": "Limpar variáveis do ambiente",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v1/metas?page=0&size=1",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "v1",
                "metas?page=0&size=1"
              ]
            }
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "['metaInit','metaId','metaVigenciaInicio','metaVigenciaFim','metaAlvo','metaOperador','metaPrioridade','metaJust','bootstrapCriterioId','bootstrapUnidadeId','bootstrapEspecialidadeId'].forEach(k=>pm.environment.unset(k));",
                  "pm.test('Variáveis limpas', () => true);"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}