<div th:fragment="content">
    <h2 class="h5 mb-3"
        th:text="${form.id} != null ? 'Editar avaliação' : 'Nova avaliação'">
        Avaliação
    </h2>

    <form th:object="${form}"
          th:action="${form.id} != null ? @{'/app/avaliacoes/' + ${form.id}} : @{/app/avaliacoes}"
          method="post"
          class="card p-3">

        <div class="row g-3">

            <!-- Título -->
            <div class="col-md-8">
                <label class="form-label" for="titulo">Título</label>
                <input id="titulo" type="text" class="form-control"
                       placeholder="Ex.: Avaliação de desempenho 2025 – Pronto Atendimento"
                       th:field="*{titulo}">
                <div class="text-danger"
                     th:if="${#fields.hasErrors('titulo')}"
                     th:errors="*{titulo}"></div>
            </div>

            <!-- k-mínimo -->
            <div class="col-md-4">
                <label class="form-label" for="kMinimo">k-mínimo (anonimato)</label>
                <input id="kMinimo" type="number" min="2"
                       class="form-control text-end"
                       th:field="*{kMinimo}">
                <div class="form-text">
                    Número mínimo de participantes para exibir resultados individualizados.
                </div>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('kMinimo')}"
                     th:errors="*{kMinimo}"></div>
            </div>

            <!-- Data início -->
            <div class="col-md-3">
                <label class="form-label" for="dataInicioAplic">Início da aplicação</label>
                <input id="dataInicioAplic" type="date"
                       class="form-control"
                       th:field="*{dataInicioAplic}">
            </div>

            <!-- Data fim -->
            <div class="col-md-3">
                <label class="form-label" for="dataFimAplic">Fim da aplicação</label>
                <input id="dataFimAplic" type="date"
                       class="form-control"
                       th:field="*{dataFimAplic}">
            </div>

            <!-- Escopo dos participantes -->
            <div class="col-md-3">
                <label class="form-label" for="escopo">Escopo dos participantes</label>
                <select id="escopo" class="form-select" th:field="*{escopo}">
                    <option value="">Selecione...</option>
                    <option th:each="e : ${escopoOptions}"
                            th:value="${e}"
                            th:text="${e == 'GLOBAL' ? 'Global (todos os médicos)'
                                      : e == 'UNIDADE' ? 'Por unidade'
                                      : 'Por especialidade'}">
                    </option>
                </select>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('escopo')}"
                     th:errors="*{escopo}"></div>
            </div>

            <!-- Unidade (mostrada quando escopo = UNIDADE) -->
            <div class="col-md-3" id="grupo-unidade">
                <label class="form-label" for="idUnidade">Unidade</label>
                <select id="idUnidade" class="form-select" th:field="*{idUnidade}">
                    <option value="">Selecione a unidade...</option>
                    <option th:each="u : ${unidades}"
                            th:value="${u.idUnidade}"
                            th:text="${u.nome}">
                    </option>
                </select>
            </div>

            <!-- Especialidade (mostrada quando escopo = ESPECIALIDADE) -->
            <div class="col-md-3" id="grupo-especialidade">
                <label class="form-label" for="idEspecialidade">Especialidade</label>
                <select id="idEspecialidade" class="form-select" th:field="*{idEspecialidade}">
                    <option value="">Selecione a especialidade...</option>
                    <option th:each="e : ${especialidades}"
                            th:value="${e.idEspecialidade}"
                            th:text="${e.nome}">
                    </option>
                </select>
            </div>

            <!-- Status -->
            <div class="col-md-3">
                <label class="form-label" for="status">Status</label>
                <select id="status" class="form-select"
                        th:field="*{status}">
                    <option value="">Selecione...</option>
                    <option th:each="s : ${statusOptions}"
                            th:value="${s}"
                            th:text="${s}">
                    </option>
                </select>
                <div class="text-danger"
                     th:if="${#fields.hasErrors('status')}"
                     th:errors="*{status}"></div>
            </div>

            <!-- Ativo -->
            <div class="col-md-3">
                <label class="form-label d-block">Situação</label>
                <div class="form-check form-switch mt-1">
                    <input class="form-check-input" type="checkbox"
                           id="ativo" th:field="*{ativo}">
                    <label class="form-check-label" for="ativo">Ativo</label>
                </div>
            </div>

        </div>

        <div class="mt-3 d-flex justify-content-between">
            <a class="btn btn-outline-secondary"
               th:href="@{/app/avaliacoes}">
                Cancelar
            </a>

            <button type="submit" class="btn btn-primary">
                Salvar
            </button>
        </div>
    </form>

    <script th:inline="javascript">
        function atualizarVisibilidadeEscopo() {
            var escopo = document.getElementById('escopo').value;
            var grupoUnidade = document.getElementById('grupo-unidade');
            var grupoEspecialidade = document.getElementById('grupo-especialidade');

            if (escopo === 'UNIDADE') {
                grupoUnidade.style.display = 'block';
                grupoEspecialidade.style.display = 'none';
            } else if (escopo === 'ESPECIALIDADE') {
                grupoUnidade.style.display = 'none';
                grupoEspecialidade.style.display = 'block';
            } else {
                // GLOBAL ou vazio
                grupoUnidade.style.display = 'none';
                grupoEspecialidade.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var escopoSelect = document.getElementById('escopo');
            if (escopoSelect) {
                escopoSelect.addEventListener('change', atualizarVisibilidadeEscopo);
                atualizarVisibilidadeEscopo(); // estado inicial
            }
        });
    </script>
</div>
