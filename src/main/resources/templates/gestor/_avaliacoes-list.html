<div th:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">Avaliações</h2>
        <a class="btn btn-success" th:href="@{/app/avaliacoes/nova}">Nova avaliação</a>
    </div>

    <!-- Filtros -->
    <form class="row g-2 mb-3" method="get" th:action="@{/app/avaliacoes}">

        <!-- Título / termo -->
        <div class="col-md-4">
            <input class="form-control"
                   type="search"
                   name="termo"
                   placeholder="Título ou parte..."
                   th:value="${filtroTermo}">
        </div>

        <!-- Status -->
        <div class="col-md-3">
            <select class="form-select" name="status">
                <option value="">Status (todos)</option>
                <option th:each="st : ${statusOptions}"
                        th:value="${st}"
                        th:text="${st}"
                        th:selected="${st} == ${filtroStatus}">
                </option>
            </select>
        </div>

        <!-- Vigente em (data) -->
        <div class="col-md-3">
            <input class="form-control"
                   type="date"
                   name="naData"
                   th:value="${filtroNaData}">
        </div>

        <!-- Botões -->
        <div class="col-md-2 d-flex align-items-end justify-content-end gap-2">
            <button class="btn btn-primary" type="submit">Filtrar</button>
            <a class="btn btn-outline-secondary"
               th:href="@{/app/avaliacoes}">Limpar</a>
        </div>
    </form>

    <!-- Tabela -->
    <table class="table table-hover align-middle">
        <thead>
        <tr>
            <th>Título</th>
            <th style="width: 260px;">Período</th>
            <th class="text-center">Qtde de questões</th>
            <th class="text-center" style="width: 140px;">Status</th>
            <th class="text-end" style="width: 180px;">Ações</th>
        </tr>
        </thead>
        <tbody>

        <tr th:each="a : ${avaliacoes}">
            <td th:text="${a.titulo}">Título</td>

            <!-- Período já formatado pela VM -->
            <td>
                <span th:text="${a.periodo}">01/01/2025 – 31/01/2025</span>
            </td>

            <!-- Total de questões -->
            <td class="text-center"
                th:text="${a.totalQuestoes}">12</td>

            <td class="text-center">
        <span class="badge"
              th:text="${a.status}"
              th:classappend="
                ${a.status} == 'RASCUNHO'  ? ' text-bg-secondary' :
                (${a.status} == 'PUBLICADA' ? ' text-bg-primary'   :
                                              ' text-bg-dark')
              ">
            RASCUNHO
        </span>
            </td>

            <td class="text-end">
                <div th:switch="${a.status}">

                    <!-- RASCUNHO → pode editar -->
                    <div th:case="'RASCUNHO'">
                        <a class="btn btn-sm btn-outline-primary"
                           th:href="@{'/app/avaliacoes/' + ${a.id} + '/editar'}">
                            Editar
                        </a>
                    </div>

                    <!-- PUBLICADA → pode suspender -->
                    <div th:case="'PUBLICADA'">
                        <form th:action="@{'/app/avaliacoes/' + ${a.id} + '/suspender'}"
                              method="post"
                              class="d-inline">

                            <!-- CSRF -->
                            <th:block th:if="${_csrf != null}">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"/>
                            </th:block>

                            <input type="hidden" name="confirm"
                                   th:value="${confirmSuspensaoId != null and confirmSuspensaoId == a.id} ? 'true' : 'false'"/>

                            <button type="submit"
                                    class="btn btn-sm btn-outline-danger"
                                    th:text="${confirmSuspensaoId != null and confirmSuspensaoId == a.id}
                                 ? 'Confirmar suspensão'
                                 : 'Suspender'">
                                Suspender
                            </button>
                        </form>
                    </div>

                    <!-- ENCERRADA (e demais) → apenas visualizar -->
                    <div th:case="'ENCERRADA'">
                        <a class="btn btn-sm btn-outline-secondary"
                           th:href="@{'/app/avaliacoes/' + ${a.id} + '/editar'}">
                            Visualizar
                        </a>
                    </div>

                    <!-- fallback -->
                    <div th:case="*">
                        <a class="btn btn-sm btn-outline-secondary"
                           th:href="@{'/app/avaliacoes/' + ${a.id} + '/editar'}">
                            Detalhes
                        </a>
                    </div>

                </div>
            </td>

        </tr>


        <tr th:if="${#lists.isEmpty(avaliacoes)}">
            <td colspan="5" class="text-center text-muted">
                Nenhuma avaliação encontrada com os filtros atuais.
            </td>
        </tr>

        </tbody>
    </table>

    <!-- Paginação -->
    <nav class="mt-3" th:if="${avaliacoes}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${!hasPrev}? 'disabled'">
                <a class="page-link"
                   th:href="@{/app/avaliacoes(
                        page=${pageIdx-1},
                        size=${size},
                        status=${filtroStatus},
                        termo=${filtroTermo},
                        naData=${filtroNaData}
                   )}">
                    Anterior
                </a>
            </li>

            <li class="page-item disabled">
                <span class="page-link"
                      th:text="'Página ' + (${pageIdx}+1)"></span>
            </li>

            <li class="page-item" th:classappend="${!hasNext}? 'disabled'">
                <a class="page-link"
                   th:href="@{/app/avaliacoes(
                        page=${pageIdx+1},
                        size=${size},
                        status=${filtroStatus},
                        termo=${filtroTermo},
                        naData=${filtroNaData}
                   )}">
                    Próxima
                </a>
            </li>
        </ul>
    </nav>

</div>
